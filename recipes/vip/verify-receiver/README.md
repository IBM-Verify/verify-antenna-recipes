# IBM Verify Receiver Recipe for IBM Verify Identity Protection Events

This recipe is complementary to the [VIP Transmitter Recipe](../transmitter/README.md) and demonstrates how to configure and deploy IBM Verify Antenna as a receiver for the events generated by the VIP transmitter. Together, these recipes form a complete end-to-end solution for processing and responding to IBM Verify Identity Protection security events.

## Overview

While the VIP Transmitter recipe focuses on transforming IBM Verify Identity Protection events into standardized SSF events, this receiver recipe shows how to:

1. Receive those standardized security events from the VIP transmitter
2. Process risk level change events using the session_revoked.js action handler
3. Perform automated actions in IBM Verify, including:
   - Revoking user sessions
   - Resetting user passwords

This creates a complete security automation workflow from detection to response.

## Prerequisites

- IBM Verify tenant: Sign up for a free trial at [ibm.biz/verify-trial](https://ibm.biz/verify-trial)
- A container runtime like Docker or Podman installed
- An IBM Verify Identity Protection (VIP) transmitter configured and running (see [VIP Transmitter Recipe](../transmitter/README.md))

## Deployment

Follow the instructions in [Container Runtime Deployment](../../../deploying/receiver/container-runtime/README.md) to set up the basic IBM Verify Antenna receiver. Stop at building the directory structure, as you'll need to add additional files specific to this recipe.

## Configuration

### Create an API Client in IBM Verify

1. Create a new API client in IBM Verify using the instructions provided in the [IBM Verify documentation](https://www.ibm.com/docs/en/security-verify?topic=access-creating-api-clients). Choose the following entitlements:
   - Read users and groups
   - Reset password of any user
   - Revoke all sessions for a user

2. Copy the client ID and secret from the API client you created.

3. Create or identify users in the Cloud Directory identity source realm that match the subjects in your VIP events. Ensure that they have valid email addresses.

### Configure the Session Revoked Action Handler

1. Copy the `session_revoked.js` file from `recipes/vip/verify-receiver/configs/js/` to your `antenna-receiver/configs/js/` directory.

2. Modify the following properties in the `session_revoked.js` file:
   - `TENANT`: Your IBM Verify tenant hostname
   - `CLIENT_ID`: The API client ID created in the previous section
   - `CLIENT_SECRET`: The API client secret created in the previous section

### Update the Processor Configuration

1. Open `antenna-receiver/configs/processor.yml`.

2. Add or modify the configuration for the risk level change event type:

   ```yaml
   processor:
     action_rules:
       - event_type: "https://schemas.openid.net/secevent/caep/event-type/risk-level-change"
         content: "@js/session_revoked.js"
   ```

3. Save the file.

### Complete the Receiver Setup

Follow the remaining instructions in the [Container Runtime Deployment](../../../deploying/receiver/container-runtime/README.md) guide to complete the receiver configuration and deployment.

## Registering with the VIP Transmitter

To register your receiver with the IBM Verify Identity Protection transmitter:

1. Copy the [create_stream_with_oauth_client.sh](../../../deploying/receiver/scripts/) to your local machine.

2. Modify the script with the following properties:
   ```bash
   CLIENT_ID="<Your API Client ID>"
   CLIENT_SECRET="<Your API Client Secret>"
   TENANT="<Your IBM Verify Tenant>"
   RECEIVER_HOSTNAME="receiver.dune.com"  # Update with your receiver hostname
   TRANSMITTER_METADATA_URL="https://<transmitter-hostname>:9044/.well-known/ssf-configuration"
   ```

3. Add `https://schemas.openid.net/secevent/caep/event-type/risk-level-change` to the list of events in the `events_requested` array in the payload.

4. Run the script to register your receiver with the VIP transmitter.

## Testing

To test the risk level change event handling:

1. Use the test scripts provided in the VIP transmitter recipe:
   - `test_user_compromised_event.sh` - Generates a credential compromise and risk level change event. Given the configuration, only the risk level change event will be handled.
   - `test_unauthorized_access.sh` - Generates a risk level change event

2. Verify the results:
   - Check the receiver logs to see the event being processed
   - Confirm that the user's sessions have been revoked
   - Verify that the user's password has been reset (they should receive an email)

## How It Works

The risk level change event handling flow works as follows:

1. The IBM Verify Identity Protection transmitter sends a risk level change event to your IBM Verify Antenna receiver
2. The receiver processes the event using the `session_revoked.js` action handler
3. The action handler:
   - Authenticates with IBM Verify using the API client credentials
   - Finds the user that matches the subject in the event
   - Revokes all active sessions for that user
   - Resets the user's password and triggers a notification email

## Next Steps

After successfully deploying the VIP receiver:

1. Implement an action handler for credential compromise events:
   - Create a new JavaScript file (e.g., `credential_compromise.js`) in the `configs/js` directory
   - Add the event type to `processor.yml`:
     ```yaml
     - event_type: "https://schemas.openid.net/secevent/risc/event-type/credential-compromise"
       content: "@js/credential_compromise.js"
     ```
   - Implement appropriate actions for credential compromise events, such as:
     - Updating an attribute in the user profile that forces multi-factor authentication through an access policy
     - Disable the user entirely if the user's email is compromised. You can verify this by checking if the `credential_type` in the event in `email`
     
2. Explore other event types that may be generated by the IBM Verify Identity Protection transmitter

## Troubleshooting

- Check the receiver logs for errors
- Verify that the API client has the correct entitlements
- Ensure the users exist in IBM Verify with the exact usernames specified in the events
- Check that the transmitter is correctly sending events to the receiver